name: Single-Platform Image Sync Fix

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•åˆ°é•œåƒä»“åº“
      - name: ç™»å½•åˆ° cnb é•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: Sync Images
        run: |
          set -eo pipefail
          
          docker buildx create --name img_sync --use
          docker buildx inspect --bootstrap

          while IFS= read -r line; do
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥è¡Œ
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            platforms=$(echo "$line" | awk '{$1=$2=""; print $0}' | xargs | tr ',' ' ' | sed 's/^/linux\//; s/ / linux\//g')
            
            echo "ğŸ” Processing: $src_image => $dest_image [Platforms: $platforms]"

            # æ”¹è¿›çš„manifestæ£€æŸ¥é€»è¾‘
            NEED_UPDATE=false
            if docker manifest inspect "$dest_image" &>/dev/null; then
              # è·å–æºé•œåƒdigest
              src_digest=$(docker inspect --format='{{.Id}}' "$src_image" 2>/dev/null || docker manifest inspect "$src_image" | jq -r '.config.digest')
              
              # è·å–ç›®æ ‡é•œåƒdigest
              dest_digest=$(docker inspect --format='{{.Id}}' "$dest_image" 2>/dev/null || docker manifest inspect "$dest_image" | jq -r '.config.digest')

              if [ "$src_digest" != "$dest_digest" ]; then
                NEED_UPDATE=true
                echo "ğŸ”„ Update needed (${dest_digest:0:12} â†’ ${src_digest:0:12})"
              fi
            else
              NEED_UPDATE=true
              echo "ğŸ†• Destination image doesn't exist"
            fi

            if [ "$NEED_UPDATE" = true ]; then
              echo "ğŸš€ Syncing image..."
              
              # æ›´å¥å£®çš„å•å¹³å°åŒæ­¥æ–¹æ³•
              platform_args=$(echo "$platforms" | tr ' ' ',')
              
              docker pull "$src_image" --platform "$platform_args"
              docker tag "$src_image" "$dest_image"
              docker push "$dest_image"
              
              # å¯é€‰ï¼šä½¿ç”¨buildxçš„æ›¿ä»£æ–¹æ¡ˆ
              # docker buildx build \
              #   --platform "$platform_args" \
              #   --output=type=image,name=$dest_image,push=true \
              #   --cache-from=type=registry,ref=$src_image \
              #   - <<< "FROM $src_image"
              
              echo "ğŸ‰ Synced successfully: $dest_image"
            else
              echo "âœ… Already up-to-date"
            fi
          done < "$GITHUB_WORKSPACE/images.txt"

          docker buildx rm img_sync || true
