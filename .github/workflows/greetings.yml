name: Smart Multi-Arch Sync (Latest Only)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # æ¯åŠå°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ç™»å½•åˆ°é•œåƒä»“åº“
      - name: ç™»å½•åˆ° cnb é•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      # è®¾ç½® Buildx
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      # å®‰è£…å¿…è¦å·¥å…·
      - name: å®‰è£… jq
        run: sudo apt-get install -y jq

      # æ ¸å¿ƒé•œåƒåŒæ­¥é€»è¾‘
      - name: å¤šæ¶æ„é•œåƒåŒæ­¥
        run: |
          set -eo pipefail
          
          # åˆ›å»ºä¸´æ—¶æ„å»ºå™¨
          docker buildx create --name multiarch --use
          docker buildx inspect --bootstrap

          while IFS= read -r line; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥è¡Œ
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            platforms=$(echo "$line" | awk -F'[ ,]+' '{print $3}' | tr ',' ' ')
            
            echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image [å¹³å°: $platforms]"

            # æ£€æŸ¥æºé•œåƒæ˜¯å¦æœ‰æ›´æ–°
            NEED_UPDATE=false
            if ! LATEST_DIGEST=$(docker manifest inspect "$src_image" 2>/dev/null | jq -r '.config.digest'); then
              echo "âŒ æ— æ³•è·å–æºé•œåƒæ¸…å•: $src_image"
              continue
            fi

            # æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
            if docker manifest inspect "$dest_image" &>/dev/null; then
              CURRENT_DIGEST=$(docker manifest inspect "$dest_image" | jq -r '.config.digest')
              if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
                NEED_UPDATE=true
                echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°: $src_image (æ—§: ${CURRENT_DIGEST:0:12} â†’ æ–°: ${LATEST_DIGEST:0:12})"
              else
                echo "âœ… $dest_image å·²æ˜¯æœ€æ–°"
                continue
              fi
            else
              NEED_UPDATE=true
              echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œå°†åˆ›å»º: $dest_image"
            fi

            if [ "$NEED_UPDATE" = true ]; then
              echo "ğŸš€ å¼€å§‹åŒæ­¥å¤šæ¶æ„é•œåƒ..."
              docker buildx build \
                --platform "$platforms" \
                --output=type=image,name=$dest_image,push=true \
                --build-arg BASE_IMAGE=$src_image \
                - <<< "ARG BASE_IMAGE
                      FROM \$BASE_IMAGE"
              
              echo "ğŸ‰ æˆåŠŸåŒæ­¥: $dest_image"
              echo "ğŸ“Š é•œåƒæ‘˜è¦: ${LATEST_DIGEST:0:12}"
            fi
          done < $GITHUB_WORKSPACE/images.txt

          # æ¸…ç†æ„å»ºå™¨
          docker buildx rm multiarch || true

      # æ¸…ç†Dockerèµ„æº
      - name: æ¸…ç†èµ„æº
        run: |
          docker system prune -a -f
          docker builder prune -a -f