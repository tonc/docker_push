name: Smart Multi-Arch Sync (Latest Only)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'  # æ¯3å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: Restart docker
        run: sudo service docker restart

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ç™»å½•åˆ° cnb
      - name: ç™»å½•åˆ° cnb
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64,linux/arm/v7

      - name: Process Images with Update Check
        run: |
          set -e  # å‡ºç°é”™è¯¯æ—¶é€€å‡º
          
          while IFS= read -r line; do
            # è·³è¿‡æ³¨é‡Š/ç©ºè¡Œ
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            platforms=$(echo "$line" | awk '{print $3}' | tr ',' ',')

            echo "ğŸ” Processing: $src_image => $dest_image (${platforms// /,})"

            # æ£€æŸ¥æºé•œåƒæ˜¯å¦æœ‰æ›´æ–°
            NEED_UPDATE=false
            LATEST_DIGEST=$(docker manifest inspect $src_image | jq -r '.config.digest')
            
            # å°è¯•è·å–ç›®æ ‡é•œåƒçš„å½“å‰digest
            if docker manifest inspect $dest_image &> /dev/null; then
              CURRENT_DIGEST=$(docker manifest inspect $dest_image | jq -r '.config.digest')
              if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
                NEED_UPDATE=true
                echo "ğŸ”„ Update detected for $src_image"
              else
                echo "âœ… $dest_image is already up-to-date"
                continue
              fi
            else
              NEED_UPDATE=true
              echo "ğŸ†• $dest_image does not exist, will create"
            fi

            if [ "$NEED_UPDATE" = true ]; then
              # ä½¿ç”¨ buildx ç›´æ¥æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒï¼Œä¸ç”Ÿæˆä¸´æ—¶æ ‡ç­¾
              docker buildx build \
                --platform=$platforms \
                --tag=$dest_image \
                --push \
                $src_image

              echo "âœ… Successfully updated multi-arch: $dest_image"
            fi
          done < images.txt

      - name: Clean up
        run: |
          docker system prune -a -f