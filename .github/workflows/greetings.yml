# name: Smart Multi-Arch Sync (Latest Only)

# on:
#   workflow_dispatch:
#   schedule:
#     - cron: '*/30 * * * *'  # æ¯åŠå°æ—¶è¿è¡Œä¸€æ¬¡

# jobs:
#   sync:
#     runs-on: ubuntu-latest
#     steps:
#       - name: æ£€å‡ºä»£ç 
#         uses: actions/checkout@v4
      
#       # ç™»å½•åˆ°é•œåƒä»“åº“
#       - name: ç™»å½•åˆ° cnb é•œåƒä»“åº“
#         run: |
#           docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

#       # è®¾ç½® Buildx
#       - name: Setup Buildx
#         uses: docker/setup-buildx-action@v3
#         with:
#           platforms: linux/amd64,linux/arm64,linux/arm/v7

#       # å®‰è£…å¿…è¦å·¥å…·
#       - name: å®‰è£… jq
#         run: sudo apt-get install -y jq

#       # æ ¸å¿ƒé•œåƒåŒæ­¥é€»è¾‘
#       - name: å¤šæ¶æ„é•œåƒåŒæ­¥
#         run: |
#           set -eo pipefail
          
#           # åˆ›å»ºä¸´æ—¶æ„å»ºå™¨
#           docker buildx create --name multiarch --use
#           docker buildx inspect --bootstrap

#           while IFS= read -r line; do
#             # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
#             [[ "$line" =~ ^#|^$ ]] && continue

#             # è§£æè¾“å…¥è¡Œ
#             src_image=$(echo "$line" | awk '{print $1}')
#             dest_image=$(echo "$line" | awk '{print $2}')
#             platforms=$(echo "$line" | awk -F'[ ,]+' '{print $3}' | tr ',' ' ')
            
#             echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image [å¹³å°: $platforms]"

#             # æ£€æŸ¥æºé•œåƒæ˜¯å¦æœ‰æ›´æ–°
#             NEED_UPDATE=false
#             if ! LATEST_DIGEST=$(docker manifest inspect "$src_image" 2>/dev/null | jq -r '.config.digest'); then
#               echo "âŒ æ— æ³•è·å–æºé•œåƒæ¸…å•: $src_image"
#               continue
#             fi

#             # æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
#             if docker manifest inspect "$dest_image" &>/dev/null; then
#               CURRENT_DIGEST=$(docker manifest inspect "$dest_image" | jq -r '.config.digest')
#               if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
#                 NEED_UPDATE=true
#                 echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°: $src_image (æ—§: ${CURRENT_DIGEST:0:12} â†’ æ–°: ${LATEST_DIGEST:0:12})"
#               else
#                 echo "âœ… $dest_image å·²æ˜¯æœ€æ–°"
#                 continue
#               fi
#             else
#               NEED_UPDATE=true
#               echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œå°†åˆ›å»º: $dest_image"
#             fi

#             if [ "$NEED_UPDATE" = true ]; then
#               echo "ğŸš€ å¼€å§‹åŒæ­¥å¤šæ¶æ„é•œåƒ..."
#               docker buildx build \
#                 --platform "$platforms" \
#                 --output=type=image,name=$dest_image,push=true \
#                 --build-arg BASE_IMAGE=$src_image \
#                 - <<< "ARG BASE_IMAGE
#                       FROM \$BASE_IMAGE"
              
#               echo "ğŸ‰ æˆåŠŸåŒæ­¥: $dest_image"
#               echo "ğŸ“Š é•œåƒæ‘˜è¦: ${LATEST_DIGEST:0:12}"
#             fi
#           done < $GITHUB_WORKSPACE/images.txt

#           # æ¸…ç†æ„å»ºå™¨
#           docker buildx rm multiarch || true

#       # æ¸…ç†Dockerèµ„æº
#       - name: æ¸…ç†èµ„æº
#         run: |
#           docker system prune -a -f
#           docker builder prune -a -f


name: Multi-Arch Image Sync (Robust Version)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          install: true

      # ç™»å½•åˆ°é•œåƒä»“åº“
      - name: ç™»å½•åˆ° cnb é•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          docker buildx version
          docker info

      - name: Multi-platform image synchronization
        run: |
          set -eo pipefail

          # åˆ›å»ºä¸“ç”¨æ„å»ºå™¨å®ä¾‹
          docker buildx create --name multiarch_sync --driver docker-container --platform linux/amd64,linux/arm64,linux/arm/v7 --use
          docker buildx inspect --bootstrap

          # å¤„ç†é•œåƒåˆ—è¡¨
          while IFS= read -r line; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥è¡Œ (æ ¼å¼: æºé•œåƒ ç›®æ ‡é•œåƒ å¹³å°åˆ—è¡¨)
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            platforms=$(echo "$line" | awk '{$1=$2=""; print $0}' | xargs | tr ',' ' ' | tr -s ' ')

            echo "ğŸ” Processing: $src_image => $dest_image [Platforms: $platforms]"

            # è·å–æºé•œåƒæ¸…å•
            if ! src_manifest=$(docker manifest inspect "$src_image" 2>/dev/null); then
              echo "âŒ Failed to inspect source image: $src_image"
              continue
            fi

            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
            NEED_UPDATE=false
            if docker manifest inspect "$dest_image" &>/dev/null; then
              # æ¯”è¾ƒæ¯ä¸ªå¹³å°çš„digest
              for platform in $platforms; do
                # æ ‡å‡†åŒ–å¹³å°æ ‡è¯†ç¬¦ (å¤„ç†linux/arm/v7ç­‰æ ¼å¼)
                norm_platform=$(echo "$platform" | sed 's|linux/||; s|/|-|g')
                
                # è·å–æºé•œåƒdigest
                src_digest=$(echo "$src_manifest" | jq -r --arg plat "$norm_platform" '
                  .manifests[] | 
                  select(
                    (.platform.architecture + (.platform.variant? // "")) == $plat or
                    (.platform.os + "/" + .platform.architecture + (.platform.variant? // "" | "/" + .)) == $plat
                  ) | .digest')

                if [ -z "$src_digest" ]; then
                  echo "âš ï¸ Source image does not support platform: $platform"
                  continue
                fi

                # è·å–ç›®æ ‡é•œåƒdigest
                dst_digest=$(docker manifest inspect "$dest_image" | jq -r --arg plat "$norm_platform" '
                  .manifests[] | 
                  select(
                    (.platform.architecture + (.platform.variant? // "")) == $plat or
                    (.platform.os + "/" + .platform.architecture + (.platform.variant? // "" | "/" + .)) == $plat
                  ) | .digest')

                if [ "$src_digest" != "$dst_digest" ]; then
                  NEED_UPDATE=true
                  echo "ğŸ”„ Platform $platform needs update (${dst_digest:0:12} â†’ ${src_digest:0:12})"
                fi
              done
            else
              NEED_UPDATE=true
              echo "ğŸ†• Destination image does not exist"
            fi

            if [ "$NEED_UPDATE" = true ]; then
              echo "ğŸš€ Syncing multi-platform image..."
              
              # ä½¿ç”¨é«˜æ•ˆçš„registry-to-registryå¤åˆ¶
              docker buildx build \
                --platform "$platforms" \
                --output=type=image,name=$dest_image,push=true \
                --cache-from=type=registry,ref=$src_image \
                --provenance=false \
                --sbom=false \
                - <<< "FROM $src_image"
              
              echo "ğŸ‰ Successfully synced: $dest_image"
              echo "ğŸ“Š New digest: $(echo "$src_manifest" | jq -r '.config.digest' | cut -d: -f2 | head -c 12)"
            else
              echo "âœ… All platforms are up-to-date"
            fi
          done < "$GITHUB_WORKSPACE/images.txt"

          # æ¸…ç†æ„å»ºå™¨
          docker buildx rm multiarch_sync || true

      - name: Clean up
        run: |
          docker system prune -a -f --volumes
          docker builder prune -a -f