# name: Smart Multi-Arch Sync (Latest Only)

# on:
#   workflow_dispatch:
#   schedule:
#     - cron: '*/30 * * * *'  # æ¯åŠå°æ—¶è¿è¡Œä¸€æ¬¡

# jobs:
#   sync:
#     runs-on: ubuntu-latest
#     steps:
#       # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
#       - name: Maximize build space
#         uses: easimon/maximize-build-space@master
#         with:
#           root-reserve-mb: 2048
#           swap-size-mb: 128
#           remove-dotnet: 'true'
#           remove-haskell: 'true'
#           remove-android: 'true'
#           remove-codeql: 'true'
#           build-mount-path: '/var/lib/docker/'

#       - name: Restart docker
#         run: sudo service docker restart

#       - name: æ£€å‡ºä»£ç 
#         uses: actions/checkout@v4
      
#       # ç™»å½•åˆ° cnb
#       - name: ç™»å½•åˆ° cnb
#         run: |
#           docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

#       - name: Setup Buildx
#         uses: docker/setup-buildx-action@v3
#         with:
#           platforms: linux/amd64,linux/arm64,linux/arm/v7

#       - name: Process Images with Update Check
#         run: |
#           set -e  # å‡ºç°é”™è¯¯æ—¶é€€å‡º
          
#           # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ„å»ºä¸Šä¸‹æ–‡
#           mkdir -p /tmp/docker-build
#           cd /tmp/docker-build
#           echo "FROM scratch" > Dockerfile
          
#           while IFS= read -r line; do
#             # è·³è¿‡æ³¨é‡Š/ç©ºè¡Œ
#             [[ "$line" =~ ^#|^$ ]] && continue

#             # è§£æè¾“å…¥
#             src_image=$(echo "$line" | awk '{print $1}')
#             dest_image=$(echo "$line" | awk '{print $2}')
#             platforms=$(echo "$line" | awk '{print $3}' | tr ',' ',')

#             echo "ğŸ” Processing: $src_image => $dest_image (${platforms// /,})"

#             # æ£€æŸ¥æºé•œåƒæ˜¯å¦æœ‰æ›´æ–°
#             NEED_UPDATE=false
#             LATEST_DIGEST=$(docker manifest inspect $src_image | jq -r '.config.digest')
            
#             # å°è¯•è·å–ç›®æ ‡é•œåƒçš„å½“å‰digest
#             if docker manifest inspect $dest_image &> /dev/null; then
#               CURRENT_DIGEST=$(docker manifest inspect $dest_image | jq -r '.config.digest')
#               if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
#                 NEED_UPDATE=true
#                 echo "ğŸ”„ Update detected for $src_image"
#               else
#                 echo "âœ… $dest_image is already up-to-date"
#                 continue
#               fi
#             else
#               NEED_UPDATE=true
#               echo "ğŸ†• $dest_image does not exist, will create"
#             fi

#             if [ "$NEED_UPDATE" = true ]; then
#               # ä½¿ç”¨ buildx æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
#               # é€šè¿‡ --build-context æŒ‡å®šè¿œç¨‹é•œåƒä½œä¸ºæ„å»ºæº
#               docker buildx build \
#                 --platform=$platforms \
#                 --tag=$dest_image \
#                 --push \
#                 --build-context myimage=docker-image://${src_image} \
#                 --file Dockerfile .

#               echo "âœ… Successfully updated multi-arch: $dest_image"
#             fi
#           done < $GITHUB_WORKSPACE/images.txt

#       - name: Clean up
#         run: |
#           docker system prune -a -f
#           rm -rf /tmp/docker-build

name: Smart Multi-Arch Sync (Latest Only)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # - name: Maximize build space
      #   uses: easimon/maximize-build-space@master
      #   with:
      #     root-reserve-mb: 2048
      #     swap-size-mb: 128
      #     remove-dotnet: 'true'
      #     remove-haskell: 'true'
      #     remove-android: 'true'
      #     remove-codeql: 'true'

      # - name: Restart docker
      #   run: sudo service docker restart

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç™»å½•åˆ° cnb
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Process Images
        run: |
          set -e
          while IFS= read -r line; do
            [[ "$line" =~ ^#|^$ ]] && continue
            
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            platforms=$(echo "$line" | awk '{print $3}' | tr ',' ' ')

            echo "ğŸ” Processing: $src_image => $dest_image"

            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
            LATEST_DIGEST=$(docker manifest inspect $src_image 2>/dev/null | jq -r '.config.digest' || true)
            CURRENT_DIGEST=$(docker manifest inspect $dest_image 2>/dev/null | jq -r '.config.digest' || true)
            
            if [ "$LATEST_DIGEST" != "$CURRENT_DIGEST" ]; then
              echo "ğŸ”„ Update detected, syncing..."
              
              # æ–¹æ³•1ï¼šä½¿ç”¨ buildx imagetoolsï¼ˆæ¨èï¼‰
              docker buildx imagetools create --tag $dest_image $src_image
              
              # æ–¹æ³•2ï¼šæˆ–è€…ä½¿ç”¨ manifestï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
              # docker manifest rm $dest_image 2>/dev/null || true
              # docker manifest create $dest_image $(for p in $platforms; do echo "$src_image --arch ${p#*/}"; done)
              # docker manifest push $dest_image
              
              echo "âœ… Successfully synced"
            else
              echo "âœ… Already up-to-date"
            fi
          done < images.txt

      - name: Clean up
        run: |
          docker system prune -a -f