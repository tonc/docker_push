name: å•å¹³å°é•œåƒåŒæ­¥ï¼ˆç›´æ¥æ¨é€ç‰ˆï¼‰

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/15 * * * *'  # æ¯å°æ—¶æ•´ç‚¹è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      - name: åŒæ­¥é•œåƒï¼ˆç›´æ¥æ¨é€ï¼‰
        run: |
          set -eo pipefail
          
          # åˆå§‹åŒ–Buildx
          docker buildx create --name img_sync --use
          docker buildx inspect --bootstrap

          # è¯»å–é•œåƒåˆ—è¡¨æ–‡ä»¶
          while IFS= read -r line; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¡Œå†…å®¹ï¼ˆæ ¼å¼ï¼šæºé•œåƒ ç›®æ ‡é•œåƒ å¹³å°åˆ—è¡¨ï¼‰
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            raw_platforms=$(echo "$line" | awk '{$1=$2=""; print $0}' | xargs)

            # ä¿®æ­£å¹³å°å‚æ•°æ ¼å¼ï¼ˆç¤ºä¾‹è¾“å…¥ï¼šamd64,arm64 â†’ è¾“å‡ºï¼šlinux/amd64,linux/arm64ï¼‰
            platforms=$(echo "$raw_platforms" | sed 's/,/,linux\//g; s/^/linux\//')

            echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image [å¹³å°: $platforms]"

            # æ–¹æ³•1ï¼šä½¿ç”¨docker pullï¼ˆç®€å•ç›´æ¥ï¼‰
            echo "ğŸš€ æ–¹å¼1ï¼šé€šè¿‡docker pullåŒæ­¥..."
            docker pull "$src_image" --platform "$platforms"
            docker tag "$src_image" "$dest_image"
            docker push "$dest_image"

            # æ–¹æ³•2ï¼šä½¿ç”¨buildxï¼ˆæ¨èå¤šå¹³å°åœºæ™¯ï¼‰
            # echo "ğŸš€ æ–¹å¼2ï¼šé€šè¿‡buildxåŒæ­¥..."
            # docker buildx build \
            #   --platform "$platforms" \
            #   --output=type=image,name=$dest_image,push=true \
            #   --cache-from=type=registry,ref=$src_image \
            #   - <<< "FROM $src_image"

            echo "ğŸ‰ åŒæ­¥æˆåŠŸ: $dest_image"
            echo "----------------------------------------"
          done < "$GITHUB_WORKSPACE/images.txt"

          # æ¸…ç†Buildx
          docker buildx rm img_sync || true
