name: å•å¹³å°é•œåƒåŒæ­¥ï¼ˆç›´æ¥æ¨é€ç‰ˆï¼‰

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/30 * * * *'  # æ¯åŠå°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½®Docker Buildx
      - name: é…ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç¬¬ä¸‰æ­¥ï¼šç™»å½•é•œåƒä»“åº“
      - name: ç™»å½•åˆ°cnbé•œåƒä»“åº“
        run: |
          docker login docker.cnb.cool -u cnb -p ${{ secrets.cnb }}

      # ç¬¬å››æ­¥ï¼šæ‰§è¡Œé•œåƒåŒæ­¥ï¼ˆç›´æ¥æ¨é€ï¼‰
      - name: åŒæ­¥é•œåƒï¼ˆç›´æ¥æ¨é€ï¼‰
        run: |
          set -eo pipefail
          
          # åˆ›å»ºå¹¶å¯ç”¨Buildxæ„å»ºå™¨
          docker buildx create --name img_sync --use
          docker buildx inspect --bootstrap

          # é€è¡Œè¯»å–images.txtæ–‡ä»¶
          while IFS= read -r line; do
            # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
            [[ "$line" =~ ^#|^$ ]] && continue

            # è§£æè¾“å…¥è¡Œï¼šæºé•œåƒ ç›®æ ‡é•œåƒ å¹³å°åˆ—è¡¨
            src_image=$(echo "$line" | awk '{print $1}')
            dest_image=$(echo "$line" | awk '{print $2}')
            # å¤„ç†å¹³å°å‚æ•°æ ¼å¼ï¼šlinux/amd64,linux/arm64 â†’ linux/amd64 linux/arm64
            platforms=$(echo "$line" | awk '{$1=$2=""; print $0}' | xargs | tr ',' ' ' | sed 's/^/linux\//; s/ / linux\//g')
            
            echo "ğŸ” æ­£åœ¨å¤„ç†: $src_image => $dest_image [å¹³å°: $platforms]"
            echo "ğŸš€ ç›´æ¥åŒæ­¥é•œåƒä¸­..."
            
            # æ ¸å¿ƒåŒæ­¥æ“ä½œï¼ˆè·³è¿‡æ¯”å¯¹ç›´æ¥æ¨é€ï¼‰
            platform_args=$(echo "$platforms" | tr ' ' ',')  # è½¬æ¢å¹³å°å‚æ•°æ ¼å¼
            
            # æ‹‰å–æºé•œåƒ
            docker pull "$src_image" --platform "$platform_args"
            # é‡æ–°æ‰“æ ‡ç­¾
            docker tag "$src_image" "$dest_image"
            # æ¨é€åˆ°ç›®æ ‡ä»“åº“
            docker push "$dest_image"
            
            echo "ğŸ‰ åŒæ­¥æˆåŠŸ: $dest_image"
          done < "$GITHUB_WORKSPACE/images.txt"  # è¯»å–é•œåƒåˆ—è¡¨æ–‡ä»¶

          # æ¸…ç†Buildxæ„å»ºå™¨
          docker buildx rm img_sync || true
